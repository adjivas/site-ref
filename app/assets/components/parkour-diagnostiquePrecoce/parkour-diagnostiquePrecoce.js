Polymer({
    is: "parkour-diagnostiquePrecoce",
    properties: {
        steps: {
            type: Array,
            value: function () {
                return [
                    {
                        label: "Inquietudes",
                        name: "Inquietudes",
                        description: "Dès la première année, on peut mettre en évidence comparativement à des groupes d’enfants au développement typique des différences comportementales dans les groupes d’enfants ayant évolué vers l’autisme. Des résultats d’études prospectives récentes (frères et sœurs puînés d’enfants avec autisme) (222) suggèrent la valeur prédictive dès 12 mois de l’absence ou de la rareté :<li>du sourire social ;</li><li>du contact par le regard ;</li><li>de l’orientation à l’appel du prénom.</li>De nouveaux items ont été ajoutés aux examens systématiques de la première année dans la dernière version du carnet de santé (en vigueur depuis le 1er janvier 2006) :<li>à l’examen du 4e mois, les items « vocalise » et « rit aux éclats » ;</li><li>à l’examen du 9e mois, les items « pointe du doigt » et « joue à : “Coucou, le voilà” ».</li>Autour de 18 mois en moyenne mais parfois avant, certains signes doivent alerter sur un risque d’évolution vers un TED et nécessitent avis et bilans spécialisés, en même temps que démarrent des mesures d’accompagnement de l’enfant et de sa famille : <li>passivité, niveau faible de réactivité/anticipation aux stimuli sociaux \;</li><li>difficultés dans l’accrochage visuel, difficultés dans l’attention conjointe \;</li><li>retard de langage, absence de pointage, absence de comportement de désignation des objets à autrui, absence de jeu de « faire semblant ».</li>Chez un enfant de moins de 3 ans, les signes d’alerte d’un risque de TED sont les suivants :<li>communication : perturbations dans le développement du langage, utilisation inappropriée du langage, peu de réponses quand on l’appelle par son prénom, déficits dans la communication non verbale \;</li><li>socialisation : manque d’imitation, ne montre pas les objets à l’adulte, manque d’intérêt pour les autres enfants ou intérêts inhabituels, difficultés à reconnaître les émotions d’autrui, restriction des jeux imaginatifs en particulier, dans son monde, n’initie pas des jeux simples ou ne participe pas à des jeux sociaux imitatifs, préfère les activités solitaires, relation étrange avec les adultes (indifférence ou familiarité excessive) ;</li><li>intérêts, activité et autres comportements : hypersensibilité tactile ou auditive, maniérisme moteur, balancements, agressivité, conduites oppositionnelles, résistance aux changements, activités répétitives avec les objets (par exemple pour les aligner ou éteindre/allumer la lumière).</li>Quel que soit l’âge, l’existence d’une régression dans le développement (du langage ou sociocommunicatif en particulier) doit motiver avis et bilans spécialisés. Une attention particulière doit être portée aux fratries, en raison :<li>du risque de récurrence d’un TED \;</li><li>du risque de problèmes de développement ou de problèmes psychopathologiques.</li>Quelques signes ont une valeur « d’alerte absolue » d’un trouble du développement et doivent conduire à demander rapidement un avis et des examens spécialisés. Ces signes sont les suivants :<li>absence de babillage, de pointer ou d’autres gestes sociaux à 12 mois \;</li><li>absence de mots à 18 mois \;</li><li>absence d’association de mots (non écholaliques) à 24 mois \;</li><li>perte de langage ou de compétences sociales quel que soit l’âge.</li>",
                        presentation: "Le médecin de famille doit rester attentif à la détection de tout signe ou symptôme de TSA : <li>en écoutant les parents lorsqu’ils font part de préoccupations concernant le développement de leur enfant (la recherche a démontré la validité des préoccupations des parents) ;</li><li>si les parents n’expriment pas d’inquiétude, en leur demandant directement s’ils ont des préoccupations au sujet de leur enfant \;</li><li>en se renseignant au sujet des antécédents familiaux de TSA ou d’autres difficultés de développement \;</li><li>en constatant l’incapacité de l’enfant à atteindre certains stades de développement ou en faisant participer l’enfant à des activités permettant de révéler les difficultés de développement.</li>",
                        pos: [2, 6],
                    },
                    {
                        label: "Test",
                        name: "Dépistage",
                        description: "Il existe certains tests de dépistage standardisés pour évaluer le risque de TSA :<ul>le Checklist for Autism in Toddlers (CHAT – Baron-Cohen et coll., 1996) intègre des observations comportementales directes ; il peut également être utilisé par des médecins ne possédant pas de formation spécifique sur les TSA ;</ul><li>le Modifi ed Cheklist for Autism in Toddlers (M-CHAT – Robins, Fein, Barton and Green, 2001) est un court questionnaire qui peut être donné aux parents d’enfants âgés de seize à trente mois et renseigné dans la salle d’attente.</li><li>Si les résultats du dépistage sont positifs, cela ne signifi e pas que l’enfant est susceptible de présenter un diagnostic de TSA. Il est alors recommandé d’orienter l’enfant vers une équipe de diagnostic pluridisciplinaire pour une évaluation complète des différents domaines de fonctionnement de l’enfant et pour écarter d’autres troubles de la communication.</li><ul>Enfin, dans le cadre des missions qui leur sont confi ées, les centres de protection maternelle et infantile (PMI) peuvent également jouer un rôle dans le repérage précoce des TSA lors des consultations infantiles. Ils peuvent faire le lien entre l’équipe de soins de l’enfant et l’équipe scolaire qui va l’accueillir. Ils ont également un rôle d’accompagnement des familles confrontées à cette pathologie. Étant donné le manque de spécifi cité des signes d’appel chez l’adulte28, il est important, devant des diffi cultés persistantes de communication et d’adaptation sociale de la personne à son environnement, de penser aussi à un TSA. Les signes d’appel impliquent pour les médecins de rechercher leur survenue précoce et de les replacer dans l’histoire des personnes. Il est souhaitable d’impliquer également les équipes des structures médico-sociales dans le repérage des TSA et, plus largement, les professionnels travaillant au quotidien avec les adultes.</ul>",
                        presentation: "Depistage systematique des TSA chez l'enfant de moins de 3 ans",
                        pos: [4, 6],
                    },
                    {
                        label: "Test",
                        name: "Consultation Pedopsychiatre",
                        description: "Receuil d’un certain nombre de données auprès de l’entourage: histoire du développement, description des comportements, aptitudes, particularités, difficultés et observation directe de la personne.<li>Questionnaire et procédure d’observation : Austin Diagnostic Observation Schedule (ADOS) ; Childhood Autisme Ratio Scale (CARS)</li>",
                        presentation: "Pédopsychiatre",
                        pos: [6, 2],
                    },
                    {
                        label: "Test",
                        name: "Consultation Genetique",
                        description: "Le but est d’éclairer utilement les différents acteurs : <li>Famille</li><li>MDPH</li><li>Professionnels de l’intervention</li> Quant aux orientation et choix à prendre. Ces évaluations doivent aboutir à l’identification dans le dossier à présenté à la MDPH des éléments éclairants sur les répercussions dans la vie quotidienne.",
                        presentation: "<li>Evaluation psychologique</li><li>Evaluation orthophonique du langage et de la communication</li><li>Evaluation du développement psychomoteur et sensori-moteur</li>",
                        pos: [6, 4],
                    },
                    {
                        label: "Test",
                        name: "Bilan Ethiologique",
                        description: "<li>Consultation neuropédiatriques et/ou génétiques</li><li>Bilans neurométaboliques</li><li>EEG avec sieste</li><li>IRM cérébrale</li>… etc",
                        presentation: "",
                        pos: [6, 6],
                    },
                    {
                        label: "Test",
                        name: "Recour Pedopsychiatre",
                        description: "Recours contre le médecin en se basant sur l’ article R. 4127-33 du Code de la sante publique : Le médecin doit toujours élaborer son diagnostic avec le plus grand soin, en y consacrant le temps nécessaire, en s’aidant dans toute la mesure du possible des méthodes scientifiques les mieux adaptées et, s’il y a lieu, de concours appropriés ».",
                        presentation: "Recour légal possible",
                        pos: [5, 9],
                    },
                    {
                        label: "Questionnement",
                        name: "Psychologue",
                        description: "Recours contre le médecin en se basant sur l’ article R. 4127-33 du Code de la sante publique : Le médecin doit toujours élaborer son diagnostic avec le plus grand soin, en y consacrant le temps nécessaire, en s’aidant dans toute la mesure du possible des méthodes scientifiques les mieux adaptées et, s’il y a lieu, de concours appropriés ».",
                        presentation: "Bilan diagnostique multi-disciplinaire",
                        pos: [8, 1],
                    },
                    {
                        label: "Test",
                        name: "Orthophoniste",
                        description: "Recours contre le médecin en se basant sur l’ article R. 4127-33 du Code de la sante publique : Le médecin doit toujours élaborer son diagnostic avec le plus grand soin, en y consacrant le temps nécessaire, en s’aidant dans toute la mesure du possible des méthodes scientifiques les mieux adaptées et, s’il y a lieu, de concours appropriés ».",
                        presentation: "Bilan diagnostique multi-disciplinaire",
                        pos: [8, 3],
                    },
                    {
                        label: "Test",
                        name: "Psychométricien",
                        description: "Recours contre le médecin en se basant sur l’ article R. 4127-33 du Code de la sante publique : Le médecin doit toujours élaborer son diagnostic avec le plus grand soin, en y consacrant le temps nécessaire, en s’aidant dans toute la mesure du possible des méthodes scientifiques les mieux adaptées et, s’il y a lieu, de concours appropriés ».",
                        presentation: "Bilan diagnostique multi-disciplinaire",
                        pos: [8, 5],
                    },
                    {
                        label: "Test",
                        name: "Neuropediatre",
                        description: "Recours contre le médecin en se basant sur l’ article R. 4127-33 du Code de la sante publique : Le médecin doit toujours élaborer son diagnostic avec le plus grand soin, en y consacrant le temps nécessaire, en s’aidant dans toute la mesure du possible des méthodes scientifiques les mieux adaptées et, s’il y a lieu, de concours appropriés ».",
                        presentation: "Bilan diagnostique multi-disciplinaire",
                        pos: [8, 7],
                    },
                    {
                        label: "Test",
                        name: "Recour Medecin",
                        description: "Recours contre le médecin en se basant sur l’article R. 4127-33 du Code de la sante publique :<li>Le médecin doit toujours élaborer son diagnostic avec le plus grand soin, en y consacrant le temps nécessaire, en s’aidant dans toute la mesure du possible des méthodes scientifiques les mieux adaptées et, s’il y a lieu, de concours appropriés.</li><li>Le défaut de diagnostic, diagnostic erroné et le retard de diagnostic, sont sanctionnés par les tribunaux qui les qualifient comme fautes d’imprudence et de négligence. (Crim., 12 sept. 2006 : Bull. 2006 N° 219 p. 772, La semaine juridique, edition generale, 2007-01-17, n° 3, II-10006, p. 31-33, observations Thierry Faict et Patrick Mistretta</li><li>Retard de diagnostic : Civ. 1ere, 29 nov. 2005, Bulletin 2005 I N° 455 p. 382).</li>La Cour de Cassation a cependant retenu que ce retard de diagnostic doit être la cause directe du dommage, qui peut être même une simple perte de chance (c’est-à-dire la disparition actuelle et certaine d’une éventualité favorable). (Arret n° 112 du 28 janvier 2010 (08-20.755 ; 08- 21.692) - Cour de cassation - Premiere chambre civile).",
                        presentation: "Recour légal contre le professionnel de santée",
                        pos: [7, 9],
                    }
                ]
            }
        },
        connect: {
            type: Array,
            value: function () {
                return [
                    //[parent, child, mode]
                    [
                        "Inquietudes", "Dépistage", 0
                    ],
                    [
                        "Dépistage", "Consultation Pedopsychiatre", 0
                    ],
                    [
                        "Consultation Pedopsychiatre", "Consultation Genetique", 0
                    ],
                    [
                        "Consultation Genetique", "Bilan Ethiologique", 0
                    ],
                    [
                        "Consultation Pedopsychiatre", "Psychologue", 0
                    ],
                    [
                        "Consultation Pedopsychiatre", "Orthophoniste", 0
                    ],
                    [
                        "Consultation Pedopsychiatre", "Psychométricien", 0
                    ],
                    [
                        "Consultation Pedopsychiatre", "Neuropediatre", 0
                    ],
                    [
                        "Psychologue", "Recour Medecin", 1
                    ],
                    [
                        "Orthophoniste", "Recour Medecin", 1
                    ],
                    [
                        "Psychométricien", "Recour Medecin", 1
                    ],
                    [
                        "Neuropediatre", "Recour Medecin", 1
                    ],
                    [
                        "Consultation Pedopsychiatre", "Recour Pedopsychiatre", 1
                    ]
                ]
            }
        },
        dimensions: {
            type: Array,
            value: function () {
                return [10, 11]
            }
        }
    },

    width: window.innerWidth * 3 / 5,
    height: null,
    nodeColorNeutral: "white",
    nodeColorSuccess: "#8FB0B9",
    nodeColorFail: "#cc0000",
    strokeColorNeutral: "white",
    strokeColorSuccess: "#8FB0B9",
    strokeColorFail: "#cc0000",
    strokeColorCurrent: "#8FB0B9",
    linkColorNeutral: "white",
    linkColorSuccess: "#8FB0B9",
    linkColorFail: "#cc0000",
    keychain: [],
    matchChain: [],

    drawLegend: function (coeff) {
         var stageLegend = new Konva.Stage({
            container: "parkbouton",
            width: this.width,
            height: this.height
        });
        var layerLegend = new Konva.Layer();
        stageLegend.add(layerLegend);
        var legendBox = new Konva.Rect ({
            width: 500,
            height: 500,
            x: 500,
            y: 500,
            stroke: "white",
            strokeWidth: 1
        })
        layerLegend.add(legendBox);
        var nodeNeutral = new Konva.Circle({
            radius: coeff / 2,
            fill: this.nodeColorNeutral,
            stroke: this.strokeColorNeutral,
            id: "nodeNeutral",
            strokeWidth: coeff / 12
        });
        var nodeSuccess = new Konva.Circle({
            x: window.innerWidth - coeff / 2 + 50,
            y: window.innerHeight - coeff / 2,
            radius: coeff / 2,
            fill: this.nodeColorSuccess,
            stroke: this.strokeColorSuccess,
            id: "nodeSuccess",
            strokeWidth: coeff / 12
        });
        var nodeFail = new Konva.Circle({
            x: window.innerWidth - coeff / 2 + 150,
            y: window.innerHeight - coeff / 2,
            radius: coeff / 2,
            fill: this.nodeColorFail,
            stroke: this.strokeColorFail,
            id: "nodeFail",
            strokeWidth: coeff / 12
        });
        layerLegend.add(nodeNeutral);
        layerLegend.add(nodeSuccess);
        layerLegend.add(nodeFail);
        layerLegend.draw();

    },

    addNode: function(obj, coeff, layer, layerTooltip, i) {
        var nodeColor;
        var strokeColor;
        var shown = true;
        if (this.matchChain[obj.name] == "neutre") {
            nodeColor = this.nodeColorNeutral;
            strokeColor = this.strokeColorNeutral;
        } else if (this.matchChain[obj.name] == "en cour") {
            nodeColor = this.nodeColorNeutral;
            strokeColor = this.strokeColorSuccess;
        } else if (this.matchChain[obj.name] == "success") {
            nodeColor = this.nodeColorSuccess;
            strokeColor = this.strokeColorSuccess;
        } else if (this.matchChain[obj.name] == "echec") {
            nodeColor = this.nodeColorFail;
            strokeColor = this.strokeColorFail;
        }
        var node = new Konva.Circle({
            x: obj.pos[0] * coeff,
            y: obj.pos[1] * coeff,
            radius: coeff / 2,
            fill: nodeColor,
            stroke: strokeColor,
            id: obj.name,
            text: obj.name,
            strokeWidth: coeff / 12
        });
        var box = new Konva.Rect({
            x: node.x() - node.radius() - node.strokeWidth(),
            y: node.y() - node.radius() - node.strokeWidth(),
            width: 2 * node.radius() + 2 * node.strokeWidth(),
            height: 2 * node.radius() + 2 * node.strokeWidth(),
        });
        var text = new Konva.Text({
            x: node.x() - node.radius(),
            y: node.y() - node.strokeWidth(),
            width: 2 * node.radius(),
            height: 2 * node.strokeWidth(),
            text: obj.label,
            fontSize: 2 * node.strokeWidth(),
            fontFamily: "Arial",
            fontStyle: "bold",
            fontVariant: "small-caps",
            fill: "black",
            align: "center"
        });
        var group = new Konva.Group();
        group.add(node);
        group.add(box);
        group.add(text);
        var tooltip = new Konva.Text({
           text: "",
           fontFamily: "Arial",
           fontStyle: "bold",
           fontVariant: "small-caps",
           fill: "black",
           alpha: 0.75,
           visible: false
        });
        layerTooltip.add(tooltip);
        var img1 = new Image();
        img1.onload = function () {
            var valid = new Konva.Image({
                x: node.x() - coeff / 2 - coeff / 10,
                y: node.y() + coeff / 4,
                width: coeff / 4 + coeff / 12,
                height: coeff / 4 + coeff / 12,
                image: img1,
                id: "success" + String(i),
                visible: false
            });
            group.add(valid);
            valid.on('touchstart click', function () {
            console.log(obj.name);
               document.querySelector("parkour-diagnostiquePrecoce").changeStatus(obj.name, "Success");
               layer._getNodeById("success" + String(i)).hide();
                layer._getNodeById("return" + String(i)).hide();
                layer._getNodeById("fail" + String(i)).hide();
                layer.draw();
            });
            valid.on("mouseover", function () {
                this.opacity(0.5);
                document.body.style.cursor = 'pointer';
                var stage = node.getStage();
                var mousePos = stage.getPointerPosition();
                tooltip.position({
                    x : mousePos.x + 5,
                    y : mousePos.y + 5
                });
                tooltip.text('Réussite');
                tooltip.show();
                layerTooltip.batchDraw();
            });
            valid.on("mouseleave", function () {
                this.opacity(1);
                document.body.style.cursor = 'default';
                tooltip.hide();
                layerTooltip.draw();
            });
        };
        var img2 = new Image();
        img2.onload = function () {
            var fail = new Konva.Image({
                x: node.x() + coeff / 2 + coeff / 10 - coeff / 4 - coeff / 12,
                y: node.y() + coeff / 4,
                width: coeff / 4 + coeff / 12,
                height: coeff / 4 + coeff / 12,
                image: img2,
                id: "fail" + String(i),
                visible: false
            });
            group.add(fail);
            fail.on("touchstart click", function () {
               document.querySelector("parkour-diagnostiquePrecoce").changeStatus(obj.name, "Failure");
               layer._getNodeById("success" + String(i)).hide();
                layer._getNodeById("return" + String(i)).hide();
                layer._getNodeById("fail" + String(i)).hide();
                layer.draw();
            });
            fail.on("mouseover", function () {
                this.opacity(0.5);
                document.body.style.cursor = 'pointer';
                var stage = node.getStage();
                var mousePos = stage.getPointerPosition();
                tooltip.position({
                    x : mousePos.x + 5,
                    y : mousePos.y + 5
                });
                tooltip.text('Echec');
                tooltip.show();
                layerTooltip.batchDraw();
            });
            fail.on("mouseleave", function () {
                this.opacity(1);
                document.body.style.cursor = 'default';
                tooltip.hide();
                layerTooltip.draw();
            });
        };
        var img3 = new Image();
        img3.onload = function () {
            var reset = new Konva.Image({
                x: node.x() - (coeff / 4 + coeff / 12) / 2,
                y: node.y() + coeff / 4 + coeff / 12,
                width: coeff / 4 + coeff / 12,
                height: coeff / 4 + coeff / 12,
                image: img3,
                id: "return" + String(i),
                visible: false
            });
            group.add(reset);
            reset.on("touchstart click", function () {
               document.querySelector("parkour-diagnostiquePrecoce").changeStatus(obj.name, "Reset");
               layer._getNodeById("success" + String(i)).hide();
                layer._getNodeById("return" + String(i)).hide();
                layer._getNodeById("fail" + String(i)).hide();
                layer.draw();
            });
            reset.on("mouseover", function () {
                this.opacity(0.5);
                document.body.style.cursor = 'pointer';
                var stage = node.getStage();
                var mousePos = stage.getPointerPosition();
                tooltip.position({
                    x : mousePos.x + 5,
                    y : mousePos.y + 5
                });
                tooltip.text('Réinitialiser');
                tooltip.show();
                layerTooltip.batchDraw();
            });
            reset.on("mouseleave", function () {
                this.opacity(1);
                document.body.style.cursor = 'default';
                tooltip.hide();
                layerTooltip.draw();
            });
        };
        img1.src = '/assets/valider.png';
        img2.src = '/assets/cancel.png';
        img3.src = '/assets/return.png';
        layer.add(group);
        //layer.add(node);
        //layer.add(box);
            group.on('click', function () {
                document.getElementById("parktext").innerHTML = "<h2>" + obj.name + ": </h2>" + obj.presentation + "<br/>" + "<div>" + obj.description + "</div>";
                document.getElementById("parkbouton").innerHTML = "<paper-button raised " +
                    " onClick=\"document.querySelector('parkour-diagnostiquePrecoce').changeStatus('" + obj.name + "', \'Success\')\">Réussite</paper-button>" +
                    "<paper-button raised onClick=\"document.querySelector('parkour-diagnostiquePrecoce').changeStatus('" + obj.name + "', \'Failure\')\">Echec</paper-button>" +
                    "<paper-button raised onClick=\"document.querySelector('parkour-diagnostiquePrecoce').changeStatus('" + obj.name + "', \'ok\')\">Retour</paper-button>"
                    +
                    "<paper-button raised onClick=\"document.querySelector('parkour-diagnostiquePrecoce').changeStatus('" + obj.name + "', \'Reset\')\">Annulation</paper-button>";
                });
            group.on('mouseover', function () {
                node.opacity(0.5);
                text.opacity(0.5);
                document.body.style.cursor = 'pointer';
                layer._getNodeById("fail" + String(i)).show();
                layer._getNodeById("success" + String(i)).show();
                layer._getNodeById("return" + String(i)).show();
                layer.draw();
            });
            group.on('mouseleave', function () {
                node.opacity(1);
                text.opacity(1);
                document.body.style.cursor = 'default';
                layer._getNodeById("success" + String(i)).hide();
                layer._getNodeById("return" + String(i)).hide();
                layer._getNodeById("fail" + String(i)).hide();
                layer.draw();
            });
    },

    changeStatus: function (id, rep) {
        if (rep == "Success") {
            this.matchChain[id] = "success";
        } else if (rep == "Failure") {
            this.matchChain[id] = "echec";
            this.matchChain["Recour " + id] = "en cour";
        } else if (rep == "Reset") {
            var count = 0;
            var res = false;
            for (var i = 0; i < this.connect.length; i++) {
                if (this.connect[i][1] === id) {
                    count++;
                    if (this.matchChain[this.connect[i][0]] === "success") {
                        res = true;
                    }
                }
            }
            this.matchChain[id] = ((res === true) || (count === 0)) ? "en cour" : "neutre";
        } else if (rep == "ok") {
            document.getElementById("parktext").innerHTML = " ";
            document.getElementById("parkbouton").innerHTML = " ";
        }
        this.sortChain(id);
    },

    addConnect: function (connect, layer2, layer1, i, coeff) {
        if (connect[2] === 1) {
            return ;
        }
        var node1 = layer1._getNodeById(connect[0]);
        var node2 = layer1._getNodeById(connect[1]);
        var x1, y1, x2, y2, h;
        h = Math.sqrt(Math.pow(node1.x() - node2.x(), 2) + Math.pow(node1.y() - node2.y(), 2));
        x1 = Math.abs(node1.x() + ((node1.radius() + node1.strokeWidth() / 2) * ((node2.x() - node1.x()) / h)));
        y1 = Math.abs(node1.y() + ((node1.radius() + node1.strokeWidth() / 2) * ((node2.y() - node1.y()) / h)));
        x2 = Math.abs(node2.x() + ((node1.radius() + node1.strokeWidth() / 2) * ((node1.x() - node2.x()) / h)));
        y2 = Math.abs(node2.y() + ((node1.radius() + node1.strokeWidth() / 2) * ((node1.y() - node2.y()) / h)));
        var line = new Konva.Line({
            points: [x1, y1, x2, y2],
            stroke: 'white',
            strokeWidth: coeff / 12,
        });
        layer2.add(line);
    },

    sortChain: function (id) {
        for (var i = 0; i < this.connect.length; i++) {
            if (this.connect[i][0] === id) {
                if ((this.matchChain[id] === "success") && (this.matchChain[this.connect[i][1]] === "neutre") && (this.connect[i][2] === 0)) {
                    console.log(this.connect[i]);
                    this.matchChain[this.connect[i][1]] = "en cour";
                }
                else if ((this.matchChain[id] === "neutre") && (this.matchChain[this.connect[i][1]] === "en cour")) {
                    this.matchChain[this.connect[i][1]] = "neutre";
                }
                else if ((this.matchChain[id] === "echec") || (this.matchChain[id] === "en cour")) {
                    if (this.matchChain[this.connect[i][1]] === "en cour") {
                        this.matchChain[this.connect[i][1]] = "neutre";
                    }
                    if ((this.connect[i][2] === 1) && (this.matchChain[id] === "echec")) {
                        this.matchChain[this.connect[i][1]] = "en cour";
                    }
                }
            }
            else if ((this.connect[i][1] === id) && (this.connect[i][2] === 1) && (this.matchChain[this.connect[i][1]] === "success")) {
                if (this.matchChain[this.connect[i][0]] === "echec") {
                    this.matchChain[this.connect[i][0]] = "en cour";
                }
            }
        }
        this.drawNodes();
    },

    drawConnect: function (layer2, layer1, coeff) {
        for (var i = 0; i < this.connect.length; i++) {
            this.addConnect(this.connect[i], layer2, layer1, i, coeff);
        }
    },

    getMatch: function () {
        for (var i = 0; i < this.steps.length; i++) {
            this.matchChain[this.steps[i].name] = this.keychain[i];
        }
    },

    drawNodes: function () {
        var coeff = this.width / this.dimensions[0];
        this.height = coeff * this.dimensions[1];
        var stage = new Konva.Stage({
            container: "container",
            width: this.width,
            height: this.height
        });
        var layerNode = new Konva.Layer();
        var layerTooltip = new Konva.Layer();
        for (var i = 0; i < this.steps.length; i++) {
            this.addNode(this.steps[i], coeff, layerNode, layerTooltip, i);
        }
        this.drawLegend(coeff);
        var layerConnect = new Konva.Layer();
        this.drawConnect(layerConnect, layerNode, coeff);
        stage.add(layerConnect);
        stage.add(layerNode);
        stage.add(layerTooltip);
    },

    ready: function () {
        /*var elacombe = <%= user.elacombe %>;
        if (elacombe) {
            this.keychain = elacombe[nom du parkour];
        } else {
            this.keychain = getJSON(parkour.json);
        }*/
        this.keychain = ["en cour", "neutre", "neutre", "neutre", "neutre", "neutre", "neutre", "neutre", "neutre", "neutre", "neutre"];
        this.getMatch();
        this.drawNodes();
        /*$("#datepicker").datepicker({
            altField: "#datepicker",
            closeText: 'Fermer',
            prevText: 'Précédent',
            nextText: 'Suivant',
            currentText: 'Aujourd\'hui',
            monthNames: ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'],
            monthNamesShort: ['Janv.', 'Févr.', 'Mars', 'Avril', 'Mai', 'Juin', 'Juil.', 'Août', 'Sept.', 'Oct.', 'Nov.', 'Déc.'],
            dayNames: ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'],
            dayNamesShort: ['Dim.', 'Lun.', 'Mar.', 'Mer.', 'Jeu.', 'Ven.', 'Sam.'],
            dayNamesMin: ['D', 'L', 'M', 'M', 'J', 'V', 'S'],
            weekHeader: 'Sem.',
            dateFormat: 'dd-mm-yy'
        });*/
    }
});
